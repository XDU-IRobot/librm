"use strict";(self.webpackChunklibrm_docs=self.webpackChunklibrm_docs||[]).push([[209],{3418:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>h,frontMatter:()=>c,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"tutorials/sparse-value-watcher","title":"\u79bb\u6563\u503c\u76d1\u89c6\u5668","description":"\u672c\u4f8b\u7a0b\u6f14\u793a\u5982\u4f55\u4f7f\u7528 librm \u4e2d\u7684 SparseValueWatcher \u7c7b\u76d1\u89c6\u4e00\u4e2a\u79bb\u6563\u503c\u7684\u53d8\u5316\uff0c\u5e76\u5728\u503c\u53d1\u751f\u53d8\u5316\u65f6\u89e6\u53d1\u56de\u8c03\u51fd\u6570\u3002","source":"@site/docs/tutorials/sparse-value-watcher.mdx","sourceDirName":"tutorials","slug":"/tutorials/sparse-value-watcher","permalink":"/tutorials/sparse-value-watcher","draft":false,"unlisted":false,"editUrl":"https://github.com/XDU-IRobot/librm/tree/main/docs/docs/tutorials/sparse-value-watcher.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u5e8f\u5217\u64ad\u653e\u5668","permalink":"/tutorials/sequence-player"},"next":{"title":"\u9608\u503c\u89e6\u53d1","permalink":"/tutorials/threshold-trigger"}}');var l=t(4848),r=t(8453);const c={},s="\u79bb\u6563\u503c\u76d1\u89c6\u5668",i={},o=[{value:"\u4ee3\u7801\u793a\u4f8b",id:"\u4ee3\u7801\u793a\u4f8b",level:2},{value:"\u57fa\u672c\u7528\u6cd5",id:"\u57fa\u672c\u7528\u6cd5",level:3},{value:"\u76d1\u89c6\u6309\u952e\u72b6\u6001",id:"\u76d1\u89c6\u6309\u952e\u72b6\u6001",level:3},{value:"\u4f7f\u7528\u6210\u5458\u51fd\u6570\u4f5c\u4e3a\u56de\u8c03",id:"\u4f7f\u7528\u6210\u5458\u51fd\u6570\u4f5c\u4e3a\u56de\u8c03",level:3},{value:"\u4f7f\u7528 std::function",id:"\u4f7f\u7528-stdfunction",level:3},{value:"\u6a21\u677f\u53c2\u6570",id:"\u6a21\u677f\u53c2\u6570",level:2},{value:"API \u8bf4\u660e",id:"api-\u8bf4\u660e",level:2},{value:"\u6784\u9020\u51fd\u6570",id:"\u6784\u9020\u51fd\u6570",level:3},{value:"\u6210\u5458\u51fd\u6570",id:"\u6210\u5458\u51fd\u6570",level:3}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"\u79bb\u6563\u503c\u76d1\u89c6\u5668",children:"\u79bb\u6563\u503c\u76d1\u89c6\u5668"})}),"\n",(0,l.jsxs)(n.p,{children:["\u672c\u4f8b\u7a0b\u6f14\u793a\u5982\u4f55\u4f7f\u7528 librm \u4e2d\u7684 ",(0,l.jsx)(n.code,{children:"SparseValueWatcher"})," \u7c7b\u76d1\u89c6\u4e00\u4e2a\u79bb\u6563\u503c\u7684\u53d8\u5316\uff0c\u5e76\u5728\u503c\u53d1\u751f\u53d8\u5316\u65f6\u89e6\u53d1\u56de\u8c03\u51fd\u6570\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"SparseValueWatcher"})," \u9002\u7528\u4e8e\u76d1\u89c6\u72b6\u6001\u91cf\u3001\u5f00\u5173\u91cf\u3001\u679a\u4e3e\u503c\u7b49\u79bb\u6563\u53d8\u5316\u7684\u53d8\u91cf\u3002\u5f53\u68c0\u6d4b\u5230\u503c\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u4f1a\u8c03\u7528\u9884\u5148\u8bbe\u7f6e\u7684\u56de\u8c03\u51fd\u6570\uff0c\u5e76\u4f20\u5165\u53d8\u5316\u524d\u540e\u7684\u503c\u3002"]}),"\n",(0,l.jsx)(n.h2,{id:"\u4ee3\u7801\u793a\u4f8b",children:"\u4ee3\u7801\u793a\u4f8b"}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u672c\u7528\u6cd5",children:"\u57fa\u672c\u7528\u6cd5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:'#include <librm.hpp>\n#include <iostream>\n\nenum class RobotState {\n  kIdle,\n  kRunning,\n  kError,\n  kEmergency\n};\n\nint main() {\n  // \u521b\u5efa\u79bb\u6563\u503c\u76d1\u89c6\u5668\uff0c\u521d\u59cb\u72b6\u6001\u4e3a Idle\n  rm::modules::SparseValueWatcher<RobotState> state_watcher(RobotState::kIdle);\n\n  // \u8bbe\u7f6e\u503c\u53d8\u5316\u65f6\u7684\u56de\u8c03\u51fd\u6570\n  state_watcher.OnValueChange([](const RobotState &old_state, const RobotState &new_state) {\n    std::cout << "State changed from " << static_cast<int>(old_state)\n              << " to " << static_cast<int>(new_state) << std::endl;\n  });\n\n  // \u66f4\u65b0\u72b6\u6001\n  state_watcher.Update(RobotState::kRunning);  // \u89e6\u53d1\u56de\u8c03\n  state_watcher.Update(RobotState::kRunning);  // \u503c\u672a\u53d8\u5316\uff0c\u4e0d\u89e6\u53d1\n  state_watcher.Update(RobotState::kError);    // \u89e6\u53d1\u56de\u8c03\n\n  return 0;\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u76d1\u89c6\u6309\u952e\u72b6\u6001",children:"\u76d1\u89c6\u6309\u952e\u72b6\u6001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:'#include "cmsis_os.h"\n#include <librm.hpp>\n\nextern "C" void KeyMonitorTask(const void *pv_arg) {\n  // \u76d1\u89c6\u6309\u952e\u72b6\u6001\uff08\u5047\u8bbe\u6309\u952e\u72b6\u6001\u4e3a bool \u7c7b\u578b\uff09\n  rm::modules::SparseValueWatcher<bool> key_watcher(false);\n\n  key_watcher.OnValueChange([](const bool &old_val, const bool &new_val) {\n    if (new_val) {\n      // \u6309\u952e\u6309\u4e0b\n      HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_SET);\n    } else {\n      // \u6309\u952e\u91ca\u653e\n      HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_RESET);\n    }\n  });\n\n  for (;;) {\n    // \u8bfb\u53d6\u5f53\u524d\u6309\u952e\u72b6\u6001\n    bool current_state = HAL_GPIO_ReadPin(KEY_GPIO_Port, KEY_Pin) == GPIO_PIN_SET;\n\n    // \u66f4\u65b0\u76d1\u89c6\u5668\uff08\u4ec5\u5728\u72b6\u6001\u53d8\u5316\u65f6\u89e6\u53d1\u56de\u8c03\uff09\n    key_watcher.Update(current_state);\n\n    osDelay(10);\n  }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u4f7f\u7528\u6210\u5458\u51fd\u6570\u4f5c\u4e3a\u56de\u8c03",children:"\u4f7f\u7528\u6210\u5458\u51fd\u6570\u4f5c\u4e3a\u56de\u8c03"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"#include <librm.hpp>\n\nclass Robot {\n public:\n  Robot() {\n    // \u4f7f\u7528 etl::delegate \u7ed1\u5b9a\u6210\u5458\u51fd\u6570\u4f5c\u4e3a\u56de\u8c03\n    mode_watcher_.OnValueChange(\n        etl::delegate<void(const int &, const int &)>::create<Robot, &Robot::OnModeChange>(*this));\n  }\n\n  void UpdateMode(int new_mode) {\n    mode_watcher_.Update(new_mode);\n  }\n\n private:\n  void OnModeChange(const int &old_mode, const int &new_mode) {\n    // \u5904\u7406\u6a21\u5f0f\u5207\u6362\n    if (new_mode == 1) {\n      // \u8fdb\u5165\u81ea\u52a8\u6a21\u5f0f\n    } else if (new_mode == 2) {\n      // \u8fdb\u5165\u624b\u52a8\u6a21\u5f0f\n    }\n  }\n\n  rm::modules::SparseValueWatcher<int> mode_watcher_{0};\n};\n\nint main() {\n  Robot robot;\n\n  robot.UpdateMode(1);  // \u5207\u6362\u5230\u6a21\u5f0f 1\n  robot.UpdateMode(2);  // \u5207\u6362\u5230\u6a21\u5f0f 2\n\n  return 0;\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u4f7f\u7528-stdfunction",children:"\u4f7f\u7528 std::function"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:'#include <librm.hpp>\n#include <functional>\n\nint main() {\n  // \u4f7f\u7528 std::function \u800c\u975e etl::delegate\n  rm::modules::SparseValueWatcher<int, true> watcher(0);\n\n  int change_count = 0;\n\n  // \u53ef\u4ee5\u6355\u83b7\u5916\u90e8\u53d8\u91cf\n  watcher.OnValueChange([&change_count](const int &old_val, const int &new_val) {\n    change_count++;\n    std::cout << "Changed " << change_count << " times" << std::endl;\n  });\n\n  watcher.Update(1);\n  watcher.Update(2);\n  watcher.Update(3);\n\n  return 0;\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u6a21\u677f\u53c2\u6570",children:"\u6a21\u677f\u53c2\u6570"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"SparseValueWatcher"})," \u6709\u4e24\u4e2a\u6a21\u677f\u53c2\u6570\uff1a"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"T"})," - \u8981\u76d1\u89c6\u7684\u503c\u7684\u7c7b\u578b\uff0c\u9700\u8981\u652f\u6301 ",(0,l.jsx)(n.code,{children:"!="})," \u6bd4\u8f83\u8fd0\u7b97\u7b26"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"UseStdFunction"})," - \u662f\u5426\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"std::function"})," \u4f5c\u4e3a\u56de\u8c03\u7c7b\u578b\uff08\u9ed8\u8ba4\u4e3a ",(0,l.jsx)(n.code,{children:"false"}),"\uff0c\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"etl::delegate"}),"\uff09"]}),"\n"]}),"\n",(0,l.jsx)(n.admonition,{type:"tip",children:(0,l.jsxs)(n.p,{children:["\u9ed8\u8ba4\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"etl::delegate"})," \u53ef\u4ee5\u907f\u514d\u52a8\u6001\u5185\u5b58\u5206\u914d\uff0c\u5728\u5d4c\u5165\u5f0f\u7cfb\u7edf\u4e2d\u66f4\u52a0\u9ad8\u6548\u3002\u5982\u679c\u9700\u8981\u6355\u83b7\u5916\u90e8\u53d8\u91cf\u6216\u4f7f\u7528\u66f4\u590d\u6742\u7684 lambda \u8868\u8fbe\u5f0f\uff0c\u53ef\u4ee5\u8bbe\u7f6e ",(0,l.jsx)(n.code,{children:"UseStdFunction = true"})," \u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"std::function"}),"\u3002"]})}),"\n",(0,l.jsx)(n.h2,{id:"api-\u8bf4\u660e",children:"API \u8bf4\u660e"}),"\n",(0,l.jsx)(n.h3,{id:"\u6784\u9020\u51fd\u6570",children:"\u6784\u9020\u51fd\u6570"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"SparseValueWatcher()  // \u9ed8\u8ba4\u6784\u9020\nSparseValueWatcher(T initial_value)  // \u6307\u5b9a\u521d\u59cb\u503c\nSparseValueWatcher(T initial_value, Callback callback)  // \u6307\u5b9a\u521d\u59cb\u503c\u548c\u56de\u8c03\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u6210\u5458\u51fd\u6570",children:"\u6210\u5458\u51fd\u6570"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"void OnValueChange(Callback callback)"})," - \u8bbe\u7f6e\u503c\u53d8\u5316\u65f6\u7684\u56de\u8c03\u51fd\u6570"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"void Update(const T &new_value)"})," - \u66f4\u65b0\u503c\u5e76\u68c0\u67e5\u662f\u5426\u53d1\u751f\u53d8\u5316\uff0c\u5982\u679c\u53d8\u5316\u5219\u89e6\u53d1\u56de\u8c03"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"const T& value() const"})," - \u83b7\u53d6\u5f53\u524d\u503c"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>s});var a=t(6540);const l={},r=a.createContext(l);function c(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);